{"ast":null,"code":"import { HttpParams } from '@angular/common/http';\nimport { lastValueFrom } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { getDeepFromObject } from '../../helpers.define';\nimport { LocalDataSource } from '../local-data-source/local-data-source.define';\nimport { ServerSourceConf } from './server-data-source.conf';\nexport class ServerDataSource extends LocalDataSource {\n  constructor(http, conf = {}) {\n    super();\n    this.http = http;\n    this.lastRequestCount = 0;\n    this.conf = new ServerSourceConf(conf);\n    if (!this.conf.endPoint) {\n      throw new Error('At least endPoint must be specified as a configuration of the server data source.');\n    }\n  }\n  count() {\n    return this.lastRequestCount;\n  }\n  getElements() {\n    const observer$ = this.requestElements().pipe(map(res => {\n      this.lastRequestCount = this.extractTotalFromResponse(res);\n      this.data = this.extractDataFromResponse(res);\n      return this.data;\n    }));\n    return lastValueFrom(observer$);\n  }\n  /**\n   * Extracts array of data from server response\n   *\n   * @param res\n   * @returns\n   */\n  extractDataFromResponse(res) {\n    const rawData = res.body;\n    const data = Boolean(this.conf.dataKey) ? getDeepFromObject(rawData, this.conf.dataKey, []) : rawData;\n    if (data instanceof Array) {\n      return data;\n    }\n    throw new Error(`Data must be an array.\n    Please check that data extracted from the server response by the key '${this.conf.dataKey}' exists and is array.`);\n  }\n  /**\n   * Extracts total rows count from the server response\n   * Looks for the count in the heders first, then in the response body\n   *\n   * @param res\n   * @returns\n   */\n  extractTotalFromResponse(res) {\n    if (res.headers.has(this.conf.totalKey)) {\n      return Number(res.headers.get(this.conf.totalKey));\n    } else {\n      const rawData = res.body;\n      return getDeepFromObject(rawData, this.conf.totalKey, 0);\n    }\n  }\n  requestElements() {\n    const httpParams = this.createRequesParams();\n    return this.http.get(this.conf.endPoint, {\n      params: httpParams,\n      observe: 'response'\n    });\n  }\n  createRequesParams() {\n    let httpParams = new HttpParams();\n    httpParams = this.addSortRequestParams(httpParams);\n    httpParams = this.addFilterRequestParams(httpParams);\n    return this.addPagerRequestParams(httpParams);\n  }\n  addSortRequestParams(httpParams) {\n    if (this.sortConf) {\n      this.sortConf.forEach(fieldConf => {\n        httpParams = httpParams.set(this.conf.sortFieldKey, fieldConf.field);\n        httpParams = httpParams.set(this.conf.sortDirKey, fieldConf.direction.toUpperCase());\n      });\n    }\n    return httpParams;\n  }\n  addFilterRequestParams(httpParams) {\n    if (this.filterConf.filters) {\n      this.filterConf.filters.forEach(fieldConf => {\n        if (fieldConf.search) {\n          httpParams = httpParams.set(this.conf.filterFieldKey.replace('#field#', fieldConf.field), fieldConf.search);\n        }\n      });\n    }\n    return httpParams;\n  }\n  addPagerRequestParams(httpParams) {\n    if (this.pagingConf && this.pagingConf.page && this.pagingConf.perPage) {\n      httpParams = httpParams.set(this.conf.pagerPageKey, this.pagingConf.page);\n      httpParams = httpParams.set(this.conf.pagerLimitKey, this.pagingConf.perPage);\n    }\n    return httpParams;\n  }\n}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}